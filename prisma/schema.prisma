// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  Admin
  Sales
  Workshop
  Manager
}

enum MetalType {
  Gold
  WhiteGold
  RoseGold
  Silver
}

enum Karatage {
  K22
  K21
  K18
  K16
  K14
  K9
  Silver925
}

enum PaymentType {
  Cash
  Card
  Koko
}

enum JewelrySize {
  Ring
  Chain
  Bracelet
  BanglesWithScrews
  BanglesWithoutScrews
}

enum BillType {
  ReadyMade
  CustomInitial
  CustomFinal
  Repair
  OldGold
}

enum WastageStatus {
  Excess
  Low
  Ideal
}

enum ReceiptType {
  Repair
  OldGold
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  role      Role     @default(Sales)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Customer {
  id        String   @id @default(cuid())
  name      String
  address   String
  phone     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  bills     Bill[]
  receipts  Receipt[]
}

model Bill {
  id              String   @id @default(cuid())
  billNumber      String   @unique
  billType        BillType @default(ReadyMade)
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  billDate        DateTime @default(now())
  deliveryDate    DateTime?
  
  subtotal        Float    @default(0)
  tax             Float    @default(0)
  paymentAmount   Float    @default(0)
  paymentType     PaymentType @default(Cash)
  
  // Ready-made specific
  oldGoldValue    Float    @default(0)
  balance         Float    @default(0)
  customerSignature String?
  address         String?  // Optional override or for non-registered customers
  
  // Custom order specific
  designImage     String?
  specialRemarks  String?
  targetWeight    Float?
  targetPrice     Float?
  finalWeight     Float?
  finalPrice      Float?
  weightDifference Float?
  finalWeightPhoto String? // Mandatory in backend for final bill
  
  items           BillItem[]
  worksheet       WorksheetItem? @relation(fields: [worksheetId], references: [id])
  worksheetId     String? @unique
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model BillItem {
  id              String   @id @default(cuid())
  billId          String
  bill            Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)
  
  description     String
  metalType       MetalType
  karatage        Karatage
  weight          Float
  size            JewelrySize
  sizeValue       String?
  price           Float
  totalValue      Float
  
  paymentType     PaymentType
  
  inventoryItemId String?
  totalStoneWeightCarats Float @default(0)
  totalStoneWeightGrams  Float @default(0)

  stones          Stone[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Stone {
  id              String   @id @default(cuid())
  billItemId      String
  billItem        BillItem @relation(fields: [billItemId], references: [id], onDelete: Cascade)
  
  stoneType       String
  treatment       String?
  numberOfStones  Int
  weightCarats    Float    @default(0) // Weight in carats
  weightGrams     Float    @default(0) // Weight in grams
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Receipt {
  id              String      @id @default(cuid())
  receiptNumber   String      @unique
  receiptType     ReceiptType
  customerId      String
  customer        Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  date            DateTime    @default(now())
  
  // For Repair items
  repairItems     RepairItem[]
  
  // For Old Gold Valuation
  oldGoldItems    OldGoldItem[]
  totalWeight     Float?      // Total weight of all old gold items
  totalPhoto      String?     // Photo of all items on scale
  valuationCharge Float       @default(0) // 0 or 500
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model RepairItem {
  id              String    @id @default(cuid())
  receiptId       String
  receipt         Receipt   @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  
  description     String
  weight          Float
  weightPhoto     String?   // Photo on scale
  damagePhoto     String?   // Photo showing damage
  repairRemark    String?   // Remark of repair to be done
  price           Float?    // Manually entered
  newSize         String?   // For resizing
  isBroken        Boolean   @default(false)
  
  // Replacing stones info
  structureDamaged Boolean  @default(false)
  stonesToReplace String?   // Text description or specific counts
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model OldGoldItem {
  id              String    @id @default(cuid())
  receiptId       String
  receipt         Receipt   @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  
  description     String?
  weight          Float
  weightPhoto     String?
  isBroken        Boolean   @default(false)
  brokenPhoto     String?
  specialRemark   String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model InventoryItem {
  id              String   @id @default(cuid())
  itemName        String
  description     String
  metalType       MetalType
  karatage        Karatage
  weight          Float
  size            JewelrySize
  sizeValue       String?
  price           Float
  quantity        Int       @default(1)
  barcode         String?   @unique // Future plan: barcode
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model WorksheetItem {
  id              String   @id @default(cuid())
  bill            Bill?    
  
  date            DateTime @default(now())
  goldsmithName   String
  
  // Auto-filled from bill
  jewelryDescription String
  size            String
  specialRemarks  String?
  metalType       MetalType
  metalKaratage   Karatage
  targetMetalWeight Float
  theoreticalWastage Float
  
  // Manual uploads
  goldGivenPhoto      String?
  goldPurityReport    String?
  goldGiven           Float
  goldGivenPurity     Float   @default(0) // Purity of gold given (e.g. 0.75)
  
  // Stone details
  stoneDetails    StoneWorksheetDetail[]
  
  // Wastage tracking
  finalWeight         Float?
  finalWeightPhoto    String?
  finalMetalWeight    Float?
  allowedWastage      Float?
  goldBalance         Float?
  goldBalancePhoto    String?
  goldBalancePurity   Float?   // Purity of gold balance
  purityComment       String?
  purityCorrectedGoldBalance Float?
  actualWastage       Float?
  differenceInWastage Float?
  wastageStatus       WastageStatus?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model StoneWorksheetDetail {
  id              String   @id @default(cuid())
  worksheetId     String
  worksheet       WorksheetItem @relation(fields: [worksheetId], references: [id], onDelete: Cascade)
  
  stoneType       String
  size            String
  weight          Float
  weightPhoto     String?
  smallStoneSize  String?
  numberOfSmallStones Int?
  smallStoneWeight Float?
  totalStoneWeight Float?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model WastageRecord {
  id              String   @id @default(cuid())
  worksheetId     String?
  
  metalType       MetalType
  karatage        Karatage
  
  targetWeight    Float
  theoreticalWastage Float
  finalMetalWeight Float
  allowedWastage  Float
  goldGiven       Float
  actualWastage   Float
  difference      Float
  status          WastageStatus
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model MetalPrice {
  id        String   @id @default(cuid())
  date      DateTime @unique @default(now())
  price24K  Float    // Value for 8g
  price22K  Float    // Value for 8g
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UploadedFile {
  id              String   @id @default(cuid())
  fileName        String
  fileUrl         String
  fileType        String
  createdAt       DateTime @default(now())
}
